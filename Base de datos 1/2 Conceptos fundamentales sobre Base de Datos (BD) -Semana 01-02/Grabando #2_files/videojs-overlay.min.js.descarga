!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("video.js"),require("global/window")):"function"==typeof define&&define.amd?define(["video.js","global/window"],e):t.videojsOverlay=e(t.videojs,t.window)}(this,function(t,e){"use strict";function i(t){if(void 0===t)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return t}t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e;let n={align:"top-left",class:"",content:"",debug:!1,showBackground:!0,attachToControlBar:!1,dismissOverlays:!0,overlays:[{start:"playing",end:"paused"}]},s=t.getComponent("Component"),o=t.dom||t,r=t.registerPlugin||t.plugin,a=t=>"number"==typeof t&&t==t,h=t=>"string"==typeof t&&/^\S+$/.test(t),l=function(n){var s,r;function l(t,e){let s=n.call(this,t,e)||this;return s.EOV_=4294967.295,["start","end"].forEach(function(t){let e=s.options_[t];if(a(e))s[t+"Event_"]="timeupdate";else if(h(e))s[t+"Event_"]=e;else if("start"===t)throw Error('invalid "start" option; expected number or string')}),["endListener_","rewindListener_","startListener_","pauseListener_"].forEach(function(t){s[t]=function(e){return l.prototype[t].call(i(i(s)),e)}}),s.on(t,"pause",s.pauseListener_),"timeupdate"===s.startEvent_&&s.on(t,"timeupdate",s.rewindListener_),s.shown_=!1,s.shownCount_=0,s.lastShownAt_=0,s.shownInTimeWindow_=!1,s.debug('created, listening to "'+s.startEvent_+'" for "start" and "'+(s.endEvent_||"nothing")+'" for "end"'),s.hide(),s}s=l,r=n,s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.__proto__=r;let p=l.prototype;return p.createEl=function t(){let i=this.options_,n=i.content,s=i.showBackground?"vjs-overlay-background":"vjs-overlay-no-background",r=o.createEl("div",{className:`vjs-overlay vjs-overlay-${i.align} ${i.class} ${s} vjs-hidden`});return i.quizQuestion&&(r.classList.add("quiz-question"),r.classList.add("quiz-question-content")),"string"==typeof n?r.innerHTML=n:n instanceof e.DocumentFragment?r.appendChild(n):o.appendContent(r,n),r},p.debug=function e(){if(!this.options_.debug)return;let i=t.log,n=i;for(var s=arguments.length,o=Array(s),r=0;r<s;r++)o[r]=arguments[r];i.hasOwnProperty(o[0])&&"function"==typeof i[o[0]]&&(n=i[o.shift()]),n.apply(void 0,["overlay#"+this.id()+": "].concat(o))},p.getAnnotationButtonOverlay_=function t(){let e=this.player().currentTime(),i=parseInt(this.player().duration()),n=this.player().overlays_.filter(t=>"annotation-button"===t.options_.type);if(0===n.length)return null;if(1===n.length)return n[0];for(let s=0;s<n.length;s++)if(i===n[s].options_.end&&n[s].shownCount_<3||i>n[s].options_.end&&e<n[s].options_.end)return n[s]},p.getCallToActionOverlay_=function t(){let e=this.player().currentTime(),i=parseInt(this.player().duration()),n=this.player().overlays_.filter(t=>"call-to-action"===t.options_.type);if(0===n.length)return null;if(1===n.length)return n[0];for(let s=0;s<n.length;s++)if(i===n[s].options_.start||e>i&&i<n[s].options_.start||i>n[s].options_.start&&e<n[s].options_.start)return n[s]},p.hide=function t(){return n.prototype.hide.call(this),this.debug("hidden"),this.debug('bound `startListener_` to "'+this.startEvent_+'"'),this.endEvent_&&(this.debug('unbound `endListener_` from "'+this.endEvent_+'"'),this.off(this.player(),this.endEvent_,this.endListener_)),this.on(this.player(),this.startEvent_,this.startListener_),this.player().visibleOverlay=null,"annotation-button"===this.options_.type&&(this.shownCount_++,this.shown_=!0),this.options_.quizQuestion&&(window.document.dispatchEvent(new CustomEvent("hide-quiz-question-overlay",{detail:this.el_}))),this.shown_=!1,this},p.shouldHide_=function t(e,i){let n=this.options_.end,s=this.player().overlays_.find(t=>t.rewatching);return!this.rewatching&&!!s||(a(n)?e>=n:n===i)},p.show=function t(){if(n.prototype.show.call(this),this.player().isIOS)try{this.player().inFullscreen=this.player().isFullscreen(),this.player().exitFullscreen()}catch(i){e.console.log("error exiting fullscreen",i)}if(("call-to-action"===this.options_.type||"annotation-button"===this.options_.type)&&e.document.dispatchEvent(new CustomEvent("show-video-overlay",{detail:this.options_})),this.options_.font&&(this.el_.style.fontFamily=this.options_.font),this.options_.backgroundImage&&(this.el_.style.backgroundImage=`url(${this.options_.backgroundImage})`),"call-to-action"===this.options_.type&&this.shownCount_>0&&!this.options_.allowSkip){let s=this.el_.getElementsByClassName("skip-button");s[0]&&s[0].classList.remove("d-none")}if(this.shownCount_++,this.shown_=!0,"timed-message"!==this.options_.type&&(this.off(this.player(),this.startEvent_,this.startListener_),this.debug("shown"),this.debug('unbound `startListener_` from "'+this.startEvent_+'"'),this.endEvent_&&(this.debug('bound `endListener_` to "'+this.endEvent_+'"'),this.on(this.player(),this.endEvent_,this.endListener_))),this.player().visibleOverlay=this,this.shownInTimeWindow_=!0,this.lastShownAt_=this.player().currentTime(),"call-to-action"===this.options_.type||"timed-message"===this.options_.type||"end-of-quiz-message"===this.options_.type||this.options_.quizQuestion){if(e.quiz&&(e.quiz.question_started_at_ms=Date.now()),this.options_.quizQuestion){window.document.dispatchEvent(new CustomEvent("show-quiz-question-overlay",{detail:this.options_}));let o=this.getAnnotationButtonOverlay_();null!=o&&this.player().currentTime()>o.options_.start&&this.player().currentTime()<o.options_.end&&(o.hide(),o.shownInTimeWindow_=!1,o.options_.start=this.options_.end+.35)}this.player().pause(),this.player().options_.controls&&!this.player().options_.alwaysShowControls&&(this.player().controls(!1),this.player().restoreControls=!0),this.player_.el_.getElementsByClassName("vjs-big-play-button")[0].style.display="none"}if("annotation-button"===this.options_.type&&!1===this.player().paused()&&this.player().play(),"timed-message"===this.options_.type||"end-of-quiz-message"===this.options_.type){let r=this.options_.timeout||2e3;setTimeout(t=>{this.hide(),this.player().restoreControls&&this.player().controls(!0),this.player().wasVideoPlaying,"end-of-quiz-message"===this.options_.type&&this.player().currentTime()-this.player().duration()<0&&this.player().play()},r)}return this},p.shouldShow_=function(t,e){if(this.options_.dismissOverlays&&!0===this.dismissed)return!1;let i=this.player().overlays_.filter(t=>t!==this);if(i){let n=this.getAnnotationButtonOverlay_();if("annotation-button"===this.options_.type){if(n!==this)return!1;if(i.filter(t=>t.options_.quizQuestion).some(t=>t.options_.start<0)&&n.options_.start<.25)return n.options_.start=n.options_.start+.35,!1}else if(this.options_.quizQuestion&&i.filter(t=>t.options_.quizQuestion).some(t=>t.shown_))return!!this.rewatching}if(this.player().scrubbing())return!1;let s=this.options_.start,o=this.options_.end;if(s===this.EOV_){let r=this.getCallToActionOverlay_();if("end-of-quiz-message"===this.options_.type&&r&&r.options_.start===this.EOV_)return!1;o=(s=this.player().duration()-.05)+.4}if(a(s)){if(a(o)){if("ended"!==e&&this.shownInTimeWindow_&&this.player().currentTime()-this.lastShownAt_<2)return!1;if((t<s||t>o)&&(this.shownInTimeWindow_=!1),!this.shownInTimeWindow_&&t>0&&t>=s&&t<o)return!0}else{if(!this.shownSinceSeek_&&t>=s)return this.shownSinceSeek_=!0,!0;if(t>=s&&!this.shownInTimeWindow_)return!0}if(s===this.EOV_&&this.player().ended())return!0}return s===e},p.startListener_=function t(e){let i=this.player().currentTime();this.shouldShow_(i,e.type)&&this.show()},p.pauseListener_=function t(e){let i=this.player().overlays_.filter(t=>t.shown_);if(0===i.length)return;let n=i[0].options_;"annotation-button"===n.type&&"mc"===n.position&&(i[0].shownInTimeWindow_=!1,i[0].hide())},p.endListener_=function t(e){let i=this.player().currentTime();this.shouldHide_(i,e.type)&&this.hide(),this.shouldShow_(i,e.type)&&this.show()},p.rewindListener_=function t(e){let i=this.player().currentTime(),n=this.previousTime_,s=this.options_.start,o=this.options_.end;i<n&&(this.debug("rewind detected"),a(o)&&!this.shouldShow_(i)?(this.debug("hiding; "+o+" is an integer and overlay should not show at this time"),this.shownSinceSeek_=!1,this.shownInTimeWindow_=!1,this.lastShownAt_=0,this.hide()):h(o)&&i<s&&(this.debug("hiding; show point ("+s+") is before now ("+i+") and end point ("+o+") is an event"),this.shownSinceSeek_=!1,this.shownInTimeWindow_=!1,this.lastShownAt_=0,this.hide())),this.previousTime_=i},l}(s);t.registerComponent("Overlay",l);let p=function e(i){let s=this,o=t.mergeOptions(n,i);Array.isArray(this.overlays_)&&this.overlays_.forEach(function(t){s.removeChild(t),s.controlBar&&s.controlBar.removeChild(t),t.dispose()});let r=o.overlays;delete o.overlays,this.overlays_=r.map(function(e){("call-to-action"===e.type||e.quizQuestion)&&0===e.end&&(e.end="end");let i=t.mergeOptions(o,e),n="string"==typeof i.attachToControlBar||!0===i.attachToControlBar;if(!s.controls()||!s.controlBar)return s.addChild("overlay",i);if(n&&-1!==i.align.indexOf("bottom")){let r=s.controlBar.children()[0];if(void 0!==s.controlBar.getChild(i.attachToControlBar)&&(r=s.controlBar.getChild(i.attachToControlBar)),r){let a=s.controlBar.addChild("overlay",i);return s.controlBar.el().insertBefore(a.el(),r.el()),a}}let h=s.addChild("overlay",i);return s.el().insertBefore(h.el(),s.controlBar.el()),h})};return p.VERSION="2.1.4",r("overlay",p),p});
