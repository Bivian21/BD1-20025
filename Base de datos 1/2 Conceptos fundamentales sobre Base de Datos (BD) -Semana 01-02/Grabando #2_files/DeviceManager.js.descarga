'use strict';self.DeviceManager=function(){function f(){Preferences.save("deviceSettings",a.deviceSettings)}function g(b){console.log("Detect Devices!");DeviceManagerDetect.detect(a,c=>{c&&(a.currentCameraDevices=c.currentCameraDevices,a.currentMicDevices=c.currentMicDevices,a.deviceSettings=c.deviceSettings);b()})}let a={deviceSettings:{micDeviceId:void 0,cameraDeviceId:void 0,hasPermissions:void 0},init:function(b,c){let h=e=>{Utils.isChromium()?"undefined"===typeof navigator.getUserMedia?(console.log("NOT asking for both permissions since in background of extension."),
e()):(console.log("Asking for both permissions since deviceSettings doesn't say we have it yet."),c&&c(),navigator.getUserMedia({audio:!0,video:!0},function(d){d.getTracks().forEach(k=>k.stop());a.deviceSettings.hasPermissions=!0;f();e()},function(d){console.log("Failed getUserMedia for both permissions, but will continue anyway: "+d);e()})):(console.log("NOT asking for both permissions since not chromium."),e())};Preferences.load("deviceSettings",a.deviceSettings,e=>{a.deviceSettings=e;a.currentMicDevices=
[];a.currentCameraDevices=[];a.deviceSettings.hasPermissions?(console.log("We think we've got permission but checking anyway..."),g(()=>{a.deviceSettings.micDeviceId?b():(console.log("Failed to get any mic so resetting that we DON'T have permission."),a.deviceSettings.hasPermissions=!1,h(()=>{g(b)}))})):h(()=>{g(b)})})},setSelectedMicDeviceId:function(b){a.deviceSettings.micDeviceId=b;f()},setSelectedCameraDeviceId:function(b){a.deviceSettings.cameraDeviceId=b;f()},getSelectedMicDeviceId:function(){return a.deviceSettings.micDeviceId},
getSelectedCameraDeviceId:function(){return a.deviceSettings.cameraDeviceId},getSelectedMicDevice:function(){let b=a.getSelectedMicDeviceId();for(let c of a.getCurrentMicDevices())if(void 0===b||c.deviceId===b)return c},getSelectedCameraDevice:function(){let b=a.getSelectedCameraDeviceId();for(let c of a.getCurrentCameraDevices())if(void 0===b||c.deviceId===b)return c},getSelectedMicName:function(){let b=a.getSelectedMicDevice();return b?b.label:"UNDEFINED"},getSelectedCameraName:function(){let b=
a.getSelectedCameraDevice();return b?b.label:"UNDEFINED"},getCurrentMicDevices:function(){return a.currentMicDevices},getCurrentCameraDevices:function(){return a.currentCameraDevices},getCameraDeviceIdConstraint:function(b){if(void 0===a.deviceSettings.cameraDeviceId||""===a.deviceSettings.cameraDeviceId)return b?b:!0;b||={};b.deviceId={exact:a.deviceSettings.cameraDeviceId};return b},getMicDeviceIdConstraint:function(b){if(void 0===a.deviceSettings.micDeviceId||""===a.deviceSettings.micDeviceId||
"default"===a.deviceSettings.micDeviceId)return b?b:!0;b||={};b.deviceId={exact:a.deviceSettings.micDeviceId};return b}};return a}();
self.DeviceManagerDetect=function(){function f(a,b){navigator.mediaDevices.enumerateDevices().then(function(c){let h=!1,e=!1;c.forEach(function(d){d.deviceId&&("audioinput"===d.kind&&(a.currentMicDevices.push(d),console.log("Found Mic: "+JSON.stringify(d)),a.deviceSettings.micDeviceId===d.deviceId&&(h=!0,console.log("Taking Previously Selected Mic: "+JSON.stringify(d)))),"videoinput"===d.kind&&(a.currentCameraDevices.push(d),console.log("Found Camera: "+JSON.stringify(d)),a.deviceSettings.cameraDeviceId===
d.deviceId&&(e=!0,console.log("Taking Previously Selected Camera: "+JSON.stringify(d)))))});!h&&0<a.currentMicDevices.length?(console.log("Failed to find previous mic: "+a.deviceSettings.micDeviceId),a.deviceSettings.micDeviceId=a.currentMicDevices[0].deviceId,console.log("Taking First Mic: "+JSON.stringify(a.currentMicDevices[0]))):0===a.currentMicDevices.length&&(console.log("NO mics found on this system."),a.deviceSettings.micDeviceId="");!e&&0<a.currentCameraDevices.length?(console.log("Failed to find previous camera: "+
a.deviceSettings.cameraDeviceId),a.deviceSettings.cameraDeviceId=a.currentCameraDevices[0].deviceId,console.log("Taking First Camera: "+JSON.stringify(a.currentCameraDevices[0]))):0===a.currentCameraDevices.length&&(console.log("NO webcams found on this system."),a.deviceSettings.cameraDeviceId="");b(a)}).catch(c=>{console.error("Failed while enumerating devices: "+c,c);b(null)})}let g={};Utils.isEmbed()||"undefined"!==typeof navigator.mediaDevices&&chrome.runtime.onMessage.addListener(function(a,
b,c){if(a.deviceManagerDetect)return f(a.deviceManager,c),!0});g.detect=function(a,b){"undefined"!==typeof navigator.mediaDevices?f(a,b):chrome.runtime.sendMessage({deviceManagerDetect:!0,deviceManager:a},b)};return g}();